#
#  Makefile 縺��繝�そ繝�し萓晏� (S1C33逕¨)
#

#
#  繧帥�繧蚊ャ繝医い繝若く繝�け繝√Ε縺��鄒©
#
ARCH = c33-epson-elf

#
#  繝�ぅ繝�け繝医Μ縺��鄒©
#
TOPDIR = /usr/local/c33/
LIBDIR = $(TOPDIR)/lib/gcc-lib/c33-epson-elf/3.3.2/pe/
INCDIR = $(TOPDIR)/include

#
#  繧潟Φ繝代う繝�ラ繝�う繝舌�螳夂奨
#
CPP= $(ARCH)-cpp
CC= $(ARCH)-gcc
AS= $(ARCH)-gcc
LD= $(ARCH)-ld
AR= $(ARCH)-ar
OBJDUMP= $(ARCH)-objdump
OBJCOPY= $(ARCH)-objcopy
RANLIB= ranlib
SED= sed
RM= rm
NM= nm

#
#  繧潟Φ繝代う繝�ヵ繝�げ
#
INCLUDES := $(INCLUDES) -I$(SRCDIR)/config/$(CPU)-$(TOOL) \
		 -I$(SRCDIR)/config/$(CPU) -I$(INCDIR)
COPTS := $(COPTS) -B$(TOPDIR)/ -gstabs -Wall -fno-common -O -mgda=0 -mlong-calls
LDFLAGS := $(LDFLAGS) -L$(LIBDIR)
LIBS := $(LIBS) -lc

#
#  繧��繝阪Ν縺�未縺吶ｋ螳夂奨
#
KERNEL_DIR := $(KERNEL_DIR):$(SRCDIR)/config/$(CPU)-$(TOOL)
KERNEL_DIR := $(KERNEL_DIR):$(SRCDIR)/config/$(CPU)
KERNEL_COBJS := $(KERNEL_COBJS) cpu_config.o hw_serial.o sys.o lib.o

# <83>f<83>o<83>b<83>O<8e>x<89><87><8b>@<94>\<82>瀧<8a>諾<82>揃<82>辿<92>竪<8b>`
#
# !<92><8d><88>託!
#   WINFO_FLAG<8d>\<91>蔵<91>宅<82>宅<92>竪<8b>`<82>托eventflag.c<93>�<82>瀧<82>第<8d>s<82>鱈<82>棚<82>第<82>蔵<82>辿<82>遜<82>�<81>A<8b>L<8f>q<88>卓<92>u<82>丹
#   <91>側<92>l<82>醍<8e>w<92>竪<82>袖<81>A<92><8a><8f>o<82>袖<82>第<82>蔵<82>辿<81>B
#   <82>賊<82>宅<82>遜<82>�<81>A<83>x<81>[<83>X<82>題<82>滝<82>辿TOPPERS/JSP<82>丹<95>拓<8d>X<82>袖<82>遜<8f>棚<8d><87><82>托<95>K<82>存WINFO_FLAG<8d>\<91>蔵<91>宅
#   <82>宅<8b>L<98>^<88>卓<92>u<82>丹<8a>m<94>F<82>揃<82>辿<82>賊<82>題<81>B
dbg_cmd.o : kernel_cfg.c $(CPU_DIR)-$(TOOL)/dbg_cmd.c
	$(RM) -f kernel_objs.h temp?
	$(SED) -e "1,74s/\(.*\)//" -e "89,9999s/.*//" $(KER_DIR)/eventflag.c > temp0
	$(SED) -e "/^$$/d" temp0 > temp1
	echo  >> temp1
	$(SED) -e "/_kernel_tmax_/s/^.*\(_kernel_tmax_[a-z]*\).*$$/#dxtern const ID \1;/" -e "/^[^#]/d" -e "/#[^d]/d" -e "/#define [^T]/d" -e "/^$$/d" kernel_cfg.c >> temp1

# _kernel_tmax_tskid<82>瀧<82>台<82>蔵<82>第<82>托task.h<82>醍<8b>L<8f>q<82>続<82>棚<82>第<82>蔵<82>辿<82>遜<82>�<8d>鱈<8f><9c><82>揃<82>辿<81>B
	$(SED) -e "s/#dxtern/extern/" -e "/tmax_tskid/d" -e "/TNUM_TSKID/d" temp1 > kernel_objs.h
	echo >> kernel_objs.h
	$(CC) -c $(CFLAGS) $(KERNEL_CFLAGS) $(CPU_DIR)-$(TOOL)/dbg_cmd.c
	$(RM) kernel_objs.h temp?

dbg_mon.o : kernel_cfg.c $(CPU_DIR)-$(TOOL)/dbg_mon.c
	$(RM) -f kernel_objs.h temp?
	$(SED) -e "1,74s/\(.*\)//" -e "89,9999s/.*//" $(KER_DIR)/eventflag.c > temp0
	$(SED) -e "/^$$/d" temp0 > temp1
	echo  >> temp1
	$(SED) -e "/_kernel_tmax_/s/^.*\(_kernel_tmax_[a-z]*\).*$$/#dxtern const ID \1;/" \
		   -e "/_kernel_.*cb_table/s/^\(.*_kernel_.*cb_table\[.*\)/#dxtern \1/" \
		   -e "/_kernel_.*inib_table/s/^\(.*_kernel_.*inib_table\[.*\]\).*/#dxtern \1;/" \
		   -e "/__EMPTY_LABEL/s/__.*(\(.*\)\, \(_kernel_.*table\)).*/#dxtern \1 \2\[0\];/" \
		   -e "/^[^#]/d" -e "/#[^d]/d" -e "/#define [^T]/d" -e "/^$$/d" kernel_cfg.c >> temp1

# _kernel_tmax_tskid<82>瀧<82>台<82>蔵<82>第<82>托task.h<82>醍<8b>L<8f>q<82>続<82>棚<82>第<82>蔵<82>辿<82>遜<82>�<8d>鱈<8f><9c><82>揃<82>辿<81>B
	$(SED) -e "s/#dxtern/extern/" -e "/tmax_tskid/d" temp1 > kernel_objs.h
	echo >> kernel_objs.h
	$(CC) -c $(CFLAGS) $(KERNEL_CFLAGS) $(CPU_DIR)-$(TOOL)/dbg_mon.c
	$(RM) kernel_objs.h temp?

dbg_wrap.o : $(CPU_DIR)-$(TOOL)/dbg_wrap.S
	$(CC) -c $(ASFLAGS) $<

dbg_mon_sub.o : $(CPU_DIR)-$(TOOL)/dbg_mon_sub.S
	$(CC) -c $(ASFLAGS) $<


#
#  繝�ヵ繧�Ν繝医さ繝潟ヱ繧ゃΝ繝��繝��螳夂奨
#
%.o: %.c
	$(CC) -c $(CFLAGS) $<

%.s: %.c
	$(CC) -S $(CFLAGS) $<

